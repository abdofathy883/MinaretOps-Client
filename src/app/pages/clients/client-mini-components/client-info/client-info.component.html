<section class="container">
  <!-- header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-person-circle me-2"></i>
      معلومات العميل
    </h2>
    @if (isUserAdmin || isUserAccountManager) {
    <div>
      @if (!isEditMode) {
      <button class="reset-btn" (click)="toggleEditMode()">
        <i class="bi bi-pencil me-1"></i>
        تعديل
      </button>
      } @if (isEditMode) {
      <button class="btn btn-outline-danger me-2" (click)="cancelEdit()">
        <i class="bi bi-x-circle me-1"></i>
        إلغاء
      </button>
      }
    </div>
    }
  </div>

  @if (isEditMode) {
  @if (alertMessage) {
  <div class="alert" [class]="'alert-' + alertType">
    {{ alertMessage }}
  </div>
  }
  <form [formGroup]="clientForm" (ngSubmit)="onSubmit()">
    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="bi bi-pencil-square me-2"></i>
          تعديل بيانات العميل
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="name" class="form-label">اسم العميل</label>
            <input
              type="text"
              class="form-control"
              id="name"
              formControlName="name"
              [class.is-invalid]="hasError('name')"
              placeholder="أدخل اسم العميل"
              required
            />
            @if (hasError('name')) {
            <div class="invalid-feedback">
              {{ getErrorMessage("name") }}
            </div>
            }
          </div>

          <div class="col-md-6 mb-3">
            <label for="personalPhone" class="form-label"
              >رقم الهاتف الشخصي</label
            >
            <input
              type="tel"
              class="form-control"
              id="personalPhone"
              formControlName="personalPhoneNumber"
              [class.is-invalid]="hasError('personalPhoneNumber')"
              placeholder="أدخل رقم الهاتف الشخصي"
              required
            />
            @if (hasError('personalPhoneNumber')) {
            <div class="invalid-feedback">
              {{ getErrorMessage("personalPhoneNumber") }}
            </div>
            }
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="companyName" class="form-label">اسم الشركة</label>
            <input
              type="text"
              class="form-control"
              id="companyName"
              formControlName="companyName"
              placeholder="أدخل اسم الشركة"
            />
          </div>

          <div class="col-md-6 mb-3">
            <label for="companyPhone" class="form-label">رقم هاتف الشركة</label>
            <input
              type="tel"
              class="form-control"
              id="companyPhone"
              formControlName="companyNumber"
              placeholder="أدخل رقم هاتف الشركة (اختياري)"
            />
          </div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">الايميل</label>
          <input
            type="email"
            class="form-control"
            id="email"
            formControlName="email"
            [class.is-invalid]="hasError('email')"
          />
        </div>

        <div class="mb-3">
          <label for="businessDescription" class="form-label"
            >وصف النشاط التجاري</label
          >
          <textarea
            class="form-control"
            id="businessDescription"
            formControlName="businessDescription"
            [class.is-invalid]="hasError('businessDescription')"
            rows="4"
            placeholder="أدخل وصفاً مفصلاً للنشاط التجاري للعميل"
            required
          ></textarea>
          @if (hasError('businessDescription')) {
          <div class="invalid-feedback">
            {{ getErrorMessage("businessDescription") }}
          </div>
          }
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="driveLink" class="form-label">لينك الدرايف</label>
            <input
              type="text"
              class="form-control"
              id="driveLink"
              formControlName="driveLink"
              placeholder="ادخل لينك درايف فولدر الخاص بالعميل (اختياري)"
            />
          </div>

          <div class="col-md-6 mb-3">
            <label for="discordId" class="form-label">معرف ديسكورد</label>
            <input
              type="text"
              class="form-control"
              id="discordId"
              formControlName="discordChannelId"
              placeholder="أدخل معرف ديسكورد الخاص بالعميل (اختياري)"
            />
          </div>
        </div>

        <div class="row">
          <div class="col-12 col-md-6 mb-3">
            <label for="businessActivity" class="form-label">نشاط</label>
            <input
              name="businessActivity"
              id="businessActivity"
              class="form-control"
              formControlName="businessActivity"
              [class.is-invalid]="hasError('businessActivity')"
            >
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="businessType" class="form-label">نوع العمل</label>
            <select
            name="businessType"
            id="businessType"
              class="form-select"
              formControlName="businessType"
              [class.is-invalid]="hasError('businessType')"
            >
              <option disabled selected>اختر نوع العمل</option>
              <option [value]="0">فردي</option>
              <option [value]="1">تجاري</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-12 col-md-6 mb-3">
            <label for="commercialRegisterNumber" class="form-label">رقم السجل التجاري</label>
            <input type="text" class="form-control" formControlName="commercialRegisterNumber" [class.is-invalid]="hasError('commercialRegisterNumber')" />
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="taxCardNumber" class="form-label">رقم البطاقة الضريبية</label>
            <input type="text" class="form-control" formControlName="taxCardNumber" [class.is-invalid]="hasError('taxCardNumber')" />
          </div>
        </div>

        <div class="row">
          <div class="col-12 col-md-6 mb-3">
            <label for="country" class="form-label">البلد</label>
            <select
              name="country"
              id="country"
              class="form-select"
              formControlName="country"
              [class.is-invalid]="hasError('country')"
            >
              <option disabled selected>اختر البلد</option>
              @for (country of countries; track $index) {
              <option [value]="country.value">{{ country.label }}</option>
              }
            </select>
          </div>
          <div class="col-12 col-md-6 mb-3">
            <label for="accountManagerId" class="form-label">المسئول</label>
            <select
              name="accountManagerId"
              id="accountManagerId"
              class="form-select"
              formControlName="accountManagerId"
              [class.is-invalid]="hasError('accountManagerId')"
            >
              <option disabled selected>اختر المسئول</option>
              @for (emp of employees; track emp.id) {
              <option [value]="emp.id">
                {{ emp.firstName + " " + emp.lastName }}
              </option>
              }
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label for="status" class="form-label">الحالة</label>
          <select
            name="status"
            id="status"
            class="form-select"
            formControlName="status"
          >
            <option value="0">نشط</option>
            <option value="1">متوقف مؤقتا</option>
            <option value="2">الغى التعاقد</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="statusNotes" class="form-label">وصف الحالة</label>
          <textarea
            name="statusNotes"
            id="statusNotes"
            class="form-control"
            formControlName="statusNotes"
          ></textarea>
        </div>

        <button class="add-btn">
          @if (isLoading) {
          <span class="spinner-border spinner-border-sm me-1"></span>
          جار حفظ التغييرات... } @else {
          <i class="bi bi-check-circle me-1"></i>
          حفظ التغييرات }
        </button>
        <div class="mt-3">
          <button class="btn btn-danger" (click)="deleteClient()">
            @if (isDeleteLoading) {
            <span class="spinner-border spinner-border-sm me-1"></span>
            جاري الحذف... } @else {
            <i class="bi bi-trash me-1"></i>
            حذف العميل }
          </button>
        </div>
      </div>
    </div>
  </form>
  } @if(!isEditMode) {
  <div class="card">
    <div
      class="card-header d-flex justify-content-between align-items-center form-header"
    >
      معلومات العميل
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>الاسم:</strong> {{ client?.name }}</p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>رقم الهاتف الشخصي:</strong>
            {{ client?.personalPhoneNumber }}
          </p>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-6">
          <strong>اسم الشركة:</strong> {{ client?.companyName || "غير محدد" }}
        </div>
        <div class="col-md-6">
          <p>
            <strong>رقم الشركة:</strong>
            {{ client?.companyNumber || "غير محدد" }}
          </p>
        </div>
      </div>

      <div class="mb-3">
        <strong>وصف العمل:</strong>
        <p>{{ client?.businessDescription }}</p>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <p>
            <strong>رابط Drive:</strong>
            @if (client?.driveLink) {
            <a [href]="client?.driveLink" target="_blank" class="me-2">عرض</a>
            } @if (!client?.driveLink) {
            <span>غير محدد</span>
            }
          </p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>تاريخ بداية التعاقد: </strong>
            {{ client?.createdAt }}
          </p>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <p>
            <strong>الحالة:</strong>
            <br />
            <span
              class="badge"
              [ngClass]="'status-' + getStatusClass(client?.status)"
            >
              {{ getStatusText(client?.status) }}
            </span>
          </p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>ملاحظات الحالة:</strong>
            {{ client?.statusNotes || "لا توجد ملاحظات" }}
          </p>
        </div>
      </div>
    </div>
  </div>
  }
</section>
