<section class="container my-4">
  <!-- Search Section -->
  <div class="mb-4">
    <div class="row">
      <div class="col-md-8 col-lg-6">
        <label for="searchInput" class="form-label">البحث في المهام</label>
        <div class="input-group">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="ابحث بالعنوان أو رقم المهمة..."
            [(ngModel)]="searchQuery"
            (input)="onSearchInput()"
          />
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="clearSearch()"
            [disabled]="!searchQuery"
          >
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div *ngIf="isSearching" class="mt-2">
          <div class="d-flex align-items-center">
            <div
              class="spinner-border spinner-border-sm text-primary me-2"
              role="status"
            >
              <span class="visually-hidden">جاري البحث...</span>
            </div>
            <small class="text-muted">جاري البحث...</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div>
    <form [formGroup]="filterForm">
      <p>تصفية حسب:</p>
      <div class="row">
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="fromDate" class="form-label">من</label>
          <input
            type="date"
            name="fromDate"
            id="fromDate"
            class="form-control"
            formControlName="fromDate"
          />
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="service" class="form-label">الى</label>
          <input
            type="date"
            name="toDate"
            id="toDate"
            class="form-control"
            formControlName="toDate"
          />
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="service" class="form-label">الحالة</label>
          <select name="" id="" class="form-select" formControlName="status">
            <option value="">جميع الحالات</option>
            <option value="0">لم يبدأ</option>
            <option value="1">تم الإقرار</option>
            <option value="2">قيد التنفيذ</option>
            <option value="3">قيد المراجعة</option>
            <option value="4">تحتاج تعديلات</option>
            <option value="5">مكتمل</option>
            <option value="6">مرفوضة</option>
          </select>
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="client" class="form-label">العميل</label>
          <select
            name="client"
            id="client"
            class="form-select"
            formControlName="clientId"
          >
            <option value="">جميع العملاء</option>
            @for (client of clients; track $index) {
            <option [value]="client.id">{{ client.name }}</option>
            }
          </select>
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="employee" class="form-label">الموظف</label>
          <select
            name="employee"
            id="employee"
            class="form-select"
            formControlName="employeeId"
          >
            <option value="">جميع الموظفين</option>
            @for (emp of employees; track $index) {
            <option [value]="emp.id">
              {{ emp.firstName + " " + emp.lastName }}
            </option>
            }
          </select>
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="priority" class="form-label">الاولوية</label>
          <select
            name="priority"
            id="priority"
            class="form-select"
            formControlName="priority"
          >
            <option value="">جميع الأولويات</option>
            <option value="عادي">عادي</option>
            <option value="مهم">مهم</option>
            <option value="مستعجل">مستعجل</option>
          </select>
        </div>
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="" class="form-label">الاكتمال في الموعد</label>
          <select
            name="onDeadline"
            id="onDeadline"
            class="form-select"
            formControlName="onDeadline"
          >
            <option value="">جميع المهام</option>
            <option value="yes">مكتمل في الموعد</option>
            <option value="no">غير مكتمل في الموعد</option>
            <option value="not-yet">لم يحن الموعد</option>
          </select>
        </div>
        <!-- Add the team filter back to the filters section -->
        <div class="col-6 col-lg-2 mb-2 mb-lg-0">
          <label for="team" class="form-label">الفريق</label>
          <select
            name="team"
            id="team"
            class="form-select"
            formControlName="team"
          >
            <option value="">جميع الفرق</option>
            @for (teamMapping of taskTeams; track teamMapping.team) {
            <option [value]="teamMapping.team">{{ teamMapping.name }}</option>
            }
          </select>
        </div>
        <div class="col">
          <br />
          <button class="add-btn w-100 mt-1" (click)="clearSearch()">
            مسح البحث
          </button>
        </div>
      </div>
    </form>

    <!-- Quick navigation -->
    <div class="row mt-3">
      <div class="col-12 d-flex gap-2">
        <button
          class="btn btn-sm btn-outline-primary"
          (click)="loadPreviousDay()"
          [disabled]="loading"
        >
          اليوم السابق
        </button>
        <button
          class="btn btn-sm btn-outline-primary"
          (click)="loadNextDay()"
          [disabled]="loading"
        >
          اليوم التالي
        </button>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  @if (loading) {
  <div class="text-center my-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
  </div>
  }

  <!-- Results info -->
  <div class="mb-3">
    <p class="text-muted">
      عرض {{ filteredTasks.length }} من أصل {{ totalRecords }} مهمة
    </p>
  </div>
</section>

@if (isLoadingTasks) {
<section class="container">
  <app-shimmer></app-shimmer>
</section>
}

<section class="container mb-4">
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    @if (filteredTasks) { @for (task of filteredTasks; track $index) {
    <div class="col">
      <div
        class="task-card card h-100 position-relative"
        (click)="goToTask(task.id)"
        style="cursor: pointer"
      >
        <!-- Status ribbon -->
        <div class="status-ribbon" [ngClass]="task.status | mapTaskStatusClass">
          {{
            (task.status | mapTaskStatus) +
              (isCompletedAfterDeadline(task) ? " - متأخر" : "")
          }}
        </div>

        <div class="card-body">
          <!-- Top row: Priority + ID -->
          <div class="d-flex align-items-center justify-content-between gap-2">
            <span
              class="badge priority-chip"
              [ngClass]="getPriorityClass(task.priority)"
            >
              <i
                class="bi"
                [ngClass]="{
                  'bi-flag': task.priority === 'عادي',
                  'bi-lightning-charge': task.priority === 'مهم',
                  'bi-exclamation-triangle': task.priority === 'مستعجل'
                }"
              ></i>
              {{ task.priority }}
            </span>
            <p class="mb-0">#{{ task.id }}</p>
          </div>

          <!-- Title -->
          <h5 class="card-title text-center mt-2 mb-2 text-truncate-2">
            {{ task.title }}
          </h5>
          <div
            class="d-flex align-items-center justify-content-center gap-2 mb-2"
          >
            <i class="bi bi-diagram-3"></i>
            <span class="text-muted">النوع:</span>
            <span class="fw-medium">{{ getTypeLabel(task.taskType) }}</span>
          </div>

          <!-- Description -->
          <p class="card-text text-center text-muted text-truncate-3" [innerHTML]="task.description"></p>

          <!-- Meta grid -->
          <div class="mt-2 small">
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="bi bi-person-badge"></i>
              <span class="text-muted">الموظف:</span>
              <span class="fw-medium text-truncate">{{
                task.employeeName
              }}</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="bi bi-briefcase"></i>
              <span class="text-muted">الخدمة:</span>
              <span class="fw-medium text-truncate">{{
                task.serviceName
              }}</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="bi bi-building"></i>
              <span class="text-muted">العميل:</span>
              <span class="fw-medium text-truncate">{{ task.clientName }}</span>
            </div>
            @if (task.numberOfSubTasks) {
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-building"></i>
                <span class="text-muted">عدد التاسكات:</span>
                <span class="fw-medium text-truncate">{{ task.numberOfSubTasks }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Footer with deadline and quick action -->
        <div
          class="card-footer d-flex align-items-center justify-content-between"
        >
          <small class="text-muted d-flex align-items-center gap-1">
            <i class="bi bi-calendar-event"></i>
            <span>التسليم: {{ task.deadline | date }}</span>
          </small>
          <button
            type="button"
            class="btn btn-sm btn-primary"
            (click)="$event.stopPropagation(); goToTask(task.id)"
          >
            فتح
          </button>
        </div>
      </div>
    </div>
    } } @else {
    <div class="text-center mt-4 h-50">
      <div class="empty-state">
        <h3>لا توجد مهام تطابق الفلاتر المحددة</h3>
        <p>جرب تغيير معايير البحث أو مسح الفلاتر</p>
      </div>
    </div>
    }
  </div>

  <!-- Pagination -->
  @if (totalPages > 1) {
  <div class="pagination-container mt-4 d-flex justify-content-center">
    <nav>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button
            class="page-link"
            (click)="goToPage(currentPage - 1)"
            [disabled]="currentPage === 1"
          >
            السابق
          </button>
        </li>

        @for (page of [].constructor(totalPages); track $index; let i = $index)
        {
        <li class="page-item" [class.active]="currentPage === i + 1">
          <button class="page-link" (click)="goToPage(i + 1)">
            {{ i + 1 }}
          </button>
        </li>
        }

        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button
            class="page-link"
            (click)="goToPage(currentPage + 1)"
            [disabled]="currentPage === totalPages"
          >
            التالي
          </button>
        </li>
      </ul>
    </nav>
  </div>
  }
</section>
