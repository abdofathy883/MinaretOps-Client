<div class="task-container">
  @if (task) {
  <!-- Header Section -->
  <div class="task-header d-flex align-items-center flex-wrap">
    <div class="task-title-section">
      <h1 class="task-title">{{ task.title }}</h1>
      @if (task.isArchived) {
      <h1 class="task-title">التاسك مؤرشف</h1>
      }
      <div class="task-meta">
        <span class="task-id">#{{ task.id }}</span>
      </div>
    </div>
    <div>
      @if (isUserAdmin || isUserAccountManager || isUserContentLeader ||
      isUserDesignLeader) {
      <div>
        @if (!isEditMode) {
        <button class="edit-btn" (click)="toggleEditMode()">
          <i class="bi bi-pencil me-1"></i>
          تعديل
        </button>
        } @if (isEditMode) {
        <button class="btn btn-danger me-2" (click)="cancelEdit()">
          <i class="bi bi-x-circle me-1"></i>
          إلغاء
        </button>
        }
      </div>

      }
    </div>
  </div>

  @if (!isEditMode) {
  <div class="row">
    <div class="col-lg-6 mb-md-3">
      <div class="task-details-card">
        <div class="card-header mb-2">
          <h3><i class="bi bi-info-circle"></i> تفاصيل المهمة</h3>
        </div>

        <div class="detail-item">
          <label>نوع التاسك :</label>
          <p>{{ task.taskType | mapTaskType }}</p>
        </div>

        <div class="detail-item">
          <label>الوصف:</label>
          <p class="description">{{ task.description }}</p>
        </div>

        <div class="detail-item">
          <label>العميل:</label>
          <span class="client-name">{{ task.clientName }}</span>
        </div>

        <div class="detail-item">
          <label>الخدمة:</label>
          <span class="service-name">{{ task.serviceName }}</span>
        </div>

        <div class="detail-item">
          <label>الموظف المسؤول:</label>
          <span class="employee-name">{{ task.employeeName }}</span>
        </div>

        <div class="detail-item">
          <label>المرجع:</label>
          <span class="reference" *ngIf="task.refrence; else noReference">
            <a [href]="task.refrence" target="_blank" rel="noopener noreferrer"
              >عرض الريفرنس</a
            >
          </span>
          <ng-template #noReference>
            <span class="no-reference">لا يوجد مرجع</span>
          </ng-template>
        </div>
        <div class="detail-item">
          <label>تاريخ انشاء التاسك:</label>
          <span>{{ task.createdAt | date }}</span>
        </div>

        <div class="task-history-card mt-4">
          <div class="card-header mb-2">
            <h3><i class="bi bi-clock-history"></i> سجل التغييرات</h3>
          </div>

          @if (task.taskHistory && task.taskHistory.length > 0) {
          <ul class="timeline">
            @for (h of task.taskHistory; track h.id) {
            <li class="timeline-item">
              <div class="timeline-time">
                {{ h.updatedAt | date : "short" }}
              </div>
              <div class="timeline-content">
                <div class="change-summary">
                  <span class="prop">{{ h.propertyName }}</span>
                  <span class="arrow">←</span>
                  <span class="old">{{ h.oldValue || "-" }}</span>
                  <span class="to">إلى</span>
                  <span class="new">{{ h.newValue || "-" }}</span>
                </div>
                <div class="byline">
                  <i class="bi bi-person"></i>
                  <span>تم التعديل بواسطة: {{ h.updatedByName }}</span>
                </div>
              </div>
            </li>
            }
          </ul>
          } @else {
          <div class="no-history">لا يوجد سجل تغييرات حتى الآن</div>
          }
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="task-status-card">
        <div class="card-header mb-2">
          <h3><i class="bi bi-list-task"></i> حالة المهمة</h3>
        </div>

        <!-- Current Status Display -->
        <div class="current-status">
          <label>الحالة الحالية:</label>
          <div
            class="status-badge me-3"
            [ngClass]="task.status | mapTaskStatusClass"
          >
            {{ task.status | mapTaskStatus }}
          </div>
        </div>

        <!-- Priority Display -->
        <div class="priority-section">
          <label>الأولوية:</label>
          <div
            class="priority-badge me-3"
            [ngClass]="task.priority | mapTaskPriority"
          >
            {{ task.priority }}
          </div>
        </div>

        <!-- Deadline Section -->
        <div class="deadline-section">
          <label>الموعد النهائي:</label>
          <div class="deadline-info mt-2" [ngClass]="{ overdue: isOverdue() }">
            <i class="fas fa-calendar-alt"></i>
            <span>{{ task.deadline | date : "dd/MM/yyyy" }}</span>
            <span class="overdue-warning" *ngIf="isOverdue()">
              <i class="fas fa-exclamation-triangle"></i>
              متأخر
            </span>
          </div>
        </div>

        <!-- Completion Date -->
        <div class="completion-section" *ngIf="task.completedAt">
          <label>تاريخ الإنجاز:</label>
          <span class="completion-date">
            {{ task.completedAt | date : "dd/MM/yyyy" }}
          </span>
        </div>

        <div class="info-item">
          <label>تم الإنجاز في الموعد:</label>
          <span
            class="on-time-status mt-2"
            [ngClass]="{
              'on-time': task.isCompletedOnDeadline,
              late: !task.isCompletedOnDeadline
            }"
          >
            <i
              [class]="
                task.isCompletedOnDeadline
                  ? 'bi bi-check-circle'
                  : 'bi bi-x-circle'
              "
            ></i>
            {{ task.isCompletedOnDeadline ? "نعم" : "لا" }}
          </span>
        </div>

        <!-- Status Update Section -->
        <div class="status-update-section">
          <h4>تحديث الحالة</h4>
          <div class="status-options">
            @for (status of availableStatuses; track $index) {
            <button
              class="status-option-btn"
              [ngClass]="{
                active: task.status === status.value,
                disabled: updatingStatus
              }"
              (click)="updateTaskStatus(status.value)"
              [disabled]="
                updatingStatus ||
                task.status === status.value ||
                (status.value === CustomTaskStatus.Open &&
                  task.status !== CustomTaskStatus.Open)
              "
            >
              <i [class]="status.icon"></i>
              {{ status.label }}
            </button>

            } @if (task.status !== CustomTaskStatus.Completed) {
            <button class="status-option-btn" (click)="openCompleteTaskModal()">
              <i class="bi bi-check-circle me-1"></i>
              إكمال التاسك
            </button>
            }
          </div>
          @if (isUserAdmin || isUserAccountManager) {
          <button class="archive-btn" (click)="archiveTask()">
            @if(isArchiveLoading) {
            <span
              class="spinner-border spinner-border-sm me-2"
              role="status"
              aria-hidden="true"
            ></span>
            {{ task.isArchived ? 'جاري إلغاء الأرشفة...' : 'جاري الأرشفة...' }}
            } @if (!isArchiveLoading) {
            {{ task.isArchived ? 'إلغاء الأرشفة' : 'أرشفة التاسك' }}
            }
          </button>
          @if (task.isArchived) {
          <small class="text-muted"
            >التاسك مؤرشفة. اضغط مرة اخرى لالغاء الارشفة</small
          >
          } }

          <div class="update-feedback" *ngIf="updatingStatus">
            <div class="spinner"></div>
            <span>جاري التحديث...</span>
          </div>

          @if (task.taskResources && task.taskResources.length > 0) {
          <div class="task-history-card mt-4">
            <div class="card-header mb-3">
              <h3><i class="bi bi-check-circle"></i> بيانات انهاء التاسك</h3>
            </div>
            <ul class="timeline">
              @for (r of task.taskResources; track r.id) {
              <li class="timeline-item">
                <!-- <div class="timeline-time">
                {{ h.updatedAt | date : "short" }}
              </div> -->
                <div class="timeline-content">
                  <div class="change-summary">
                    <a [href]="r.url" target="_blank">عرض الرابط</a>
                  </div>
                  <!-- <div class="byline">
                  <i class="bi bi-person"></i>
                  <span>تم التعديل بواسطة: {{ r.updatedByName }}</span>
                </div> -->
                </div>
              </li>
              }
            </ul>
            <p>{{ task.completionNotes }}</p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  } @if (isEditMode) {
  <!-- Alert Messages -->
  @if (alertMessage) {
  <div class="alert" [class]="'alert-' + alertType">
    {{ alertMessage }}
    <!-- <button class="alert-close" (click)="closeAlert()">×</button> -->
  </div>
  }
  <form [formGroup]="editTaskForm" (ngSubmit)="saveTask()">
    <div class="row">
      <div class="mb-3">
        <label for="taskType" class="form-label">نوع التاسك</label>
        <select
          name="taskType"
          id="taskType"
          formControlName="taskType"
          class="form-select"
        >
          <option [value]="0">Planning</option>
          <option [value]="1">Content Strategy</option>
          <option [value]="2">Content Writing</option>
          <option [value]="3">Logo Design</option>
          <option [value]="4">Visual Identity</option>
          <option [value]="5">Design Directions</option>
          <option [value]="6">SM Design</option>
          <option [value]="7">Printings Design</option>
          <option [value]="8">Illustrations</option>
          <option [value]="9">Voiceover</option>
          <option [value]="10">Motion</option>
          <option [value]="11">Video Editing</option>
          <option [value]="12">Publishing</option>
          <option [value]="13">Moderation</option>
          <option [value]="14">Ad Management</option>
          <option [value]="15">E Mail Marketing</option>
          <option [value]="16">WhatsApp Marketing</option>
          <option [value]="17">UI UX</option>
          <option [value]="18">WordPress</option>
          <option [value]="19">Backend</option>
          <option [value]="20">Frontend</option>
          <option [value]="21">SEO</option>
          <option [value]="22">Meeting</option>
          <option [value]="23">Hosting Management</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label for="title" class="form-label">عنوان التاسك</label>
        <input
          type="text"
          class="form-control"
          id="title"
          formControlName="title"
          [class.is-invalid]="hasError('title')"
          placeholder="أدخل عنوان المهمة"
        />
        @if (hasError('title')) {
        <div class="invalid-feedback">
          {{ getErrorMessage("title") }}
        </div>
        }
      </div>

      <div class="col-md-6 mb-3">
        <label for="priority" class="form-label">الأولوية</label>
        <select
          class="form-select"
          id="priority"
          formControlName="priority"
          [class.is-invalid]="hasError('priority')"
        >
          <option value="">اختر الأولوية</option>
          <option value="عادي">عادي</option>
          <option value="مهم">مهم</option>
          <option value="مستعجل">مستعجل</option>
        </select>
        @if (hasError('priority')) {}
        <div class="invalid-feedback">
          {{ getErrorMessage("priority") }}
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="deadline" class="form-label">موعد التسليم</label>
        <input
          type="datetime-local"
          class="form-control"
          id="deadline"
          formControlName="deadline"
          [class.is-invalid]="hasError('deadline')"
        />
        @if (hasError('deadline')) {
        <div class="invalid-feedback">
          {{ getErrorMessage("deadline") }}
        </div>
        }
      </div>

      <div class="col-md-6 mb-3">
        <label for="status" class="form-label">الحالة</label>
        <select
          class="form-select"
          id="status"
          formControlName="status"
          [class.is-invalid]="hasError('status')"
        >
          <option disabled selected>اختر الحالة</option>
          <option [value]="0">لم يبدأ</option>
          <option [value]="1">تم الاقرار</option>
          <option [value]="2">قيد التنفيذ</option>
          <option [value]="3">قيد المراجعة</option>
          <option [value]="4">تحتاج تعديلات</option>
          <option [value]="5">مكتمل</option>
        </select>
        @if (hasError('status')) {
        <div class="invalid-feedback">
          {{ getErrorMessage("status") }}
        </div>
        }
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="employee" class="form-label">الموظف</label>
        <select class="form-select" id="employee" formControlName="employeeId">
          <option value="">اختر الموظف</option>
          @for (employee of employees; track employee.id) {
          <option [value]="employee.id">
            {{ employee.firstName }} {{ employee.lastName }}
          </option>
          }
        </select>
      </div>

      <div class="col-md-6 mb-3">
        <label for="reference" class="form-label">ريفرنس</label>
        <input
          type="text"
          class="form-control"
          id="reference"
          formControlName="refrence"
          placeholder="أدخل المرجع"
        />
      </div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">وصف المهمة</label>
      <textarea
        class="form-control"
        id="description"
        rows="3"
        formControlName="description"
        placeholder="أدخل وصف المهمة"
      ></textarea>
    </div>

    <div class="">
      <button
        type="submit"
        class="add-btn"
        [disabled]="editTaskForm.invalid || isLoading"
      >
        @if (isLoading) {
        <span
          class="spinner-border spinner-border-sm me-2"
          role="status"
          aria-hidden="true"
        ></span>
        جاري التعديل... } @if(!isLoading) { تعديل }
      </button>
    </div>
    <div class="mt-3">
      <button class="btn btn-danger" (click)="deleteTask()">حذف التاسك</button>
    </div>
  </form>
  } }
</div>

<!-- Complete Task Modal -->
<div
  class="modal fade"
  id="completeTaskModal"
  tabindex="-1"
  aria-labelledby="completeTaskModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="completeTaskModalLabel">إكمال التاسك</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="completeTaskForm" (ngSubmit)="completeTask()">
          <!-- URLs Section -->
          <div class="mb-4">
            <label class="form-label fw-bold">روابط التسليم</label>
            <div formArrayName="urls">
              @for (urlControl of urlControls.controls; track $index) {
              <div class="input-group mb-2" [formGroupName]="$index">
                <input
                  type="url"
                  class="form-control"
                  formControlName="url"
                  placeholder="أدخل رابط التسليم"
                  [class.is-invalid]="
                    urlControl.get('url')?.invalid &&
                    urlControl.get('url')?.touched
                  "
                />
                <button
                  type="button"
                  class="btn btn-outline-danger"
                  (click)="removeUrl($index)"
                  [disabled]="urlControls.length === 1"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              @if (urlControl.get('url')?.invalid &&
              urlControl.get('url')?.touched) {
              <div class="invalid-feedback">
                الرابط مطلوب ويجب أن يكون صحيحاً
              </div>
              } }
            </div>
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              (click)="addUrl()"
            >
              <i class="bi bi-plus"></i> إضافة رابط آخر
            </button>
          </div>

          <!-- Completion Notes -->
          <div class="mb-3">
            <label for="completionNotes" class="form-label fw-bold"
              >ملاحظات الإكمال</label
            >
            <textarea
              class="form-control"
              id="completionNotes"
              formControlName="completionNotes"
              rows="4"
              placeholder="أدخل ملاحظات حول إكمال التاسك (اختياري)"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          إلغاء
        </button>
        <button
          type="button"
          class="btn btn-success"
          (click)="completeTask()"
          [disabled]="isCompletingTask"
        >
          @if (isCompletingTask) {
          <span
            class="spinner-border spinner-border-sm me-2"
            role="status"
            aria-hidden="true"
          ></span>
          جاري الإكمال... } @if (!isCompletingTask) {
          <i class="bi bi-check-circle me-1"></i>
          إكمال التاسك }
        </button>
      </div>
    </div>
  </div>
</div>
