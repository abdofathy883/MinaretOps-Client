<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">تقرير المهام والموظفين - اليوم</h2>
    <button class="btn btn-primary" (click)="loadDashboard()" [disabled]="loading">
      <i class="bi bi-arrow-clockwise"></i> تحديث
    </button>
  </div>

  @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
    </div>
  }

  @if (error && !loading) {
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
  }

  @if (!loading && !error) {
    <div class="row g-4">
      <!-- Working Employees -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="bi bi-person-check-fill"></i> الموظفين الحاضرين (يعملون)
              <span class="badge bg-light text-dark ms-2">{{ workingEmployees.length }}</span>
            </h5>
          </div>
          <div class="card-body">
            @if (workingEmployees.length === 0) {
              <div class="text-center text-muted py-3">
                لا يوجد موظفين يعملون حاليا
              </div>
            }
            @for (employee of workingEmployees; track trackByEmployeeId($index, employee)) {
              <div class="employee-card mb-3 border rounded">
                <div 
                  class="employee-header p-3 d-flex justify-content-between align-items-center cursor-pointer"
                  (click)="toggleEmployee(employee.employeeId)"
                  [class.bg-light]="isExpanded(employee.employeeId)"
                >
                  <div class="d-flex align-items-center flex-grow-1">
                    <span class="status-circle status-working me-3"></span>
                    <div>
                      <div class="fw-bold fs-5">{{ employee.employeeName }}</div>
                      <small class="text-muted">
                        @if (employee.workingDuration) {
                          مدة العمل: {{ shortTimeSpan(employee.workingDuration) }}
                        }
                      </small>
                    </div>
                  </div>
                  <div class="d-flex align-items-center">
                    @if (employee.tasksLoaded) {
                      <span class="badge bg-secondary me-2">{{ employee.tasks.length }} مهمة</span>
                    }
                    <i 
                      class="bi"
                      [class.bi-chevron-down]="!isExpanded(employee.employeeId)"
                      [class.bi-chevron-up]="isExpanded(employee.employeeId)"
                    ></i>
                  </div>
                </div>

                @if (isExpanded(employee.employeeId)) {
                  <div class="employee-tasks p-3 border-top">
                    @if (employee.tasksLoading) {
                      <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length === 0) {
                      <div class="text-center text-muted py-3">
                        لا توجد مهام لهذا الموظف اليوم
                      </div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length > 0) {
                      <div class="table-responsive">
                        <table class="table table-sm table-hover">
                          <thead>
                            <tr>
                              <th>المهمة</th>
                              <th>الحالة</th>
                              <th>الموعد النهائي</th>
                              <th>الأولوية</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (task of employee.tasks; track trackByTaskId($index, task)) {
                              <tr [class.table-warning]="isDeadlinePassed(task.deadline, task.status)">
                                <td>
                                  <div class="fw-bold">{{ task.title }}</div>
                                  @if (task.description) {
                                    <small class="text-muted">{{ task.description | slice:0:50 }}...</small>
                                  }
                                </td>
                                <td>
                                  <span [ngClass]="getTaskStatusClass(task.status)">
                                    {{ getTaskStatusText(task.status) }}
                                  </span>
                                </td>
                                <td [class.text-danger]="isDeadlinePassed(task.deadline, task.status)">
                                  {{ formatDeadline(task.deadline) }}
                                  @if (isDeadlinePassed(task.deadline, task.status)) {
                                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                  }
                                </td>
                                <td>
                                  <span class="badge bg-info">{{ task.priority }}</span>
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- On Break Employees -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
              <i class="bi bi-pause-circle-fill"></i> في استراحة
              <span class="badge bg-dark text-light ms-2">{{ onBreakEmployees.length }}</span>
            </h5>
          </div>
          <div class="card-body">
            @if (onBreakEmployees.length === 0) {
              <div class="text-center text-muted py-3">
                لا يوجد موظفين في استراحة
              </div>
            }
            @for (employee of onBreakEmployees; track trackByEmployeeId($index, employee)) {
              <div class="employee-card mb-3 border rounded">
                <div 
                  class="employee-header p-3 d-flex justify-content-between align-items-center cursor-pointer"
                  (click)="toggleEmployee(employee.employeeId)"
                  [class.bg-light]="isExpanded(employee.employeeId)"
                >
                  <div class="d-flex align-items-center flex-grow-1">
                    <span class="status-circle status-break me-3"></span>
                    <div>
                      <div class="fw-bold fs-5">{{ employee.employeeName }}</div>
                      <small class="text-muted">في استراحة</small>
                    </div>
                  </div>
                  <div class="d-flex align-items-center">
                    @if (employee.tasksLoaded) {
                      <span class="badge bg-secondary me-2">{{ employee.tasks.length }} مهمة</span>
                    }
                    <i 
                      class="bi"
                      [class.bi-chevron-down]="!isExpanded(employee.employeeId)"
                      [class.bi-chevron-up]="isExpanded(employee.employeeId)"
                    ></i>
                  </div>
                </div>

                @if (isExpanded(employee.employeeId)) {
                  <div class="employee-tasks p-3 border-top">
                    @if (employee.tasksLoading) {
                      <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                      </div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length === 0) {
                      <div class="text-center text-muted py-3">لا توجد مهام لهذا الموظف اليوم</div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length > 0) {
                      <div class="table-responsive">
                        <table class="table table-sm table-hover">
                          <thead>
                            <tr>
                              <th>المهمة</th>
                              <th>الحالة</th>
                              <th>الموعد النهائي</th>
                              <th>الأولوية</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (task of employee.tasks; track trackByTaskId($index, task)) {
                              <tr [class.table-warning]="isDeadlinePassed(task.deadline, task.status)">
                                <td>
                                  <div class="fw-bold">{{ task.title }}</div>
                                  @if (task.description) {
                                    <small class="text-muted">{{ task.description | slice:0:50 }}...</small>
                                  }
                                </td>
                                <td>
                                  <span [ngClass]="getTaskStatusClass(task.status)">
                                    {{ getTaskStatusText(task.status) }}
                                  </span>
                                </td>
                                <td [class.text-danger]="isDeadlinePassed(task.deadline, task.status)">
                                  {{ formatDeadline(task.deadline) }}
                                  @if (isDeadlinePassed(task.deadline, task.status)) {
                                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                  }
                                </td>
                                <td><span class="badge bg-info">{{ task.priority }}</span></td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Absent Employees -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
              <i class="bi bi-person-x-fill"></i> الغياب
              <span class="badge bg-light text-dark ms-2">{{ absentEmployees.length }}</span>
            </h5>
          </div>
          <div class="card-body">
            @if (absentEmployees.length === 0) {
              <div class="text-center text-muted py-3">
                لا يوجد موظفين غائبين
              </div>
            }
            @for (employee of absentEmployees; track trackByEmployeeId($index, employee)) {
              <div class="employee-card mb-3 border rounded">
                <div 
                  class="employee-header p-3 d-flex justify-content-between align-items-center cursor-pointer"
                  (click)="toggleEmployee(employee.employeeId)"
                  [class.bg-light]="isExpanded(employee.employeeId)"
                >
                  <div class="d-flex align-items-center flex-grow-1">
                    <span class="status-circle status-absent me-3"></span>
                    <div class="fw-bold fs-5">{{ employee.employeeName }}</div>
                  </div>
                  <div class="d-flex align-items-center">
                    @if (employee.tasksLoaded) {
                      <span class="badge bg-secondary me-2">{{ employee.tasks.length }} مهمة</span>
                    }
                    <i 
                      class="bi"
                      [class.bi-chevron-down]="!isExpanded(employee.employeeId)"
                      [class.bi-chevron-up]="isExpanded(employee.employeeId)"
                    ></i>
                  </div>
                </div>

                @if (isExpanded(employee.employeeId)) {
                  <div class="employee-tasks p-3 border-top">
                    @if (employee.tasksLoading) {
                      <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                      </div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length === 0) {
                      <div class="text-center text-muted py-3">لا توجد مهام لهذا الموظف اليوم</div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length > 0) {
                      <div class="table-responsive">
                        <table class="table table-sm table-hover">
                          <thead>
                            <tr>
                              <th>المهمة</th>
                              <th>الحالة</th>
                              <th>الموعد النهائي</th>
                              <th>الأولوية</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (task of employee.tasks; track trackByTaskId($index, task)) {
                              <tr [class.table-warning]="isDeadlinePassed(task.deadline, task.status)">
                                <td>
                                  <div class="fw-bold">{{ task.title }}</div>
                                  @if (task.description) {
                                    <small class="text-muted">{{ task.description | slice:0:50 }}...</small>
                                  }
                                </td>
                                <td>
                                  <span [ngClass]="getTaskStatusClass(task.status)">
                                    {{ getTaskStatusText(task.status) }}
                                  </span>
                                </td>
                                <td [class.text-danger]="isDeadlinePassed(task.deadline, task.status)">
                                  {{ formatDeadline(task.deadline) }}
                                  @if (isDeadlinePassed(task.deadline, task.status)) {
                                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                  }
                                </td>
                                <td><span class="badge bg-info">{{ task.priority }}</span></td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- On Leave Employees -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="bi bi-calendar-check-fill"></i> في إجازة
              <span class="badge bg-light text-dark ms-2">{{ onLeaveEmployees.length }}</span>
            </h5>
          </div>
          <div class="card-body">
            @if (onLeaveEmployees.length === 0) {
              <div class="text-center text-muted py-3">
                لا يوجد موظفين في إجازة
              </div>
            }
            @for (employee of onLeaveEmployees; track trackByEmployeeId($index, employee)) {
              <div class="employee-card mb-3 border rounded">
                <div 
                  class="employee-header p-3 d-flex justify-content-between align-items-center cursor-pointer"
                  (click)="toggleEmployee(employee.employeeId)"
                  [class.bg-light]="isExpanded(employee.employeeId)"
                >
                  <div class="d-flex align-items-center flex-grow-1">
                    <span class="status-circle status-leave me-3"></span>
                    <div class="fw-bold fs-5">{{ employee.employeeName }}</div>
                  </div>
                  <div class="d-flex align-items-center">
                    @if (employee.tasksLoaded) {
                      <span class="badge bg-secondary me-2">{{ employee.tasks.length }} مهمة</span>
                    }
                    <i 
                      class="bi"
                      [class.bi-chevron-down]="!isExpanded(employee.employeeId)"
                      [class.bi-chevron-up]="isExpanded(employee.employeeId)"
                    ></i>
                  </div>
                </div>

                @if (isExpanded(employee.employeeId)) {
                  <div class="employee-tasks p-3 border-top">
                    @if (employee.tasksLoading) {
                      <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                      </div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length === 0) {
                      <div class="text-center text-muted py-3">لا توجد مهام لهذا الموظف اليوم</div>
                    }
                    @if (!employee.tasksLoading && employee.tasks.length > 0) {
                      <div class="table-responsive">
                        <table class="table table-sm table-hover">
                          <thead>
                            <tr>
                              <th>المهمة</th>
                              <th>الحالة</th>
                              <th>الموعد النهائي</th>
                              <th>الأولوية</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (task of employee.tasks; track trackByTaskId($index, task)) {
                              <tr [class.table-warning]="isDeadlinePassed(task.deadline, task.status)">
                                <td>
                                  <div class="fw-bold">{{ task.title }}</div>
                                  @if (task.description) {
                                    <small class="text-muted">{{ task.description | slice:0:50 }}...</small>
                                  }
                                </td>
                                <td>
                                  <span [ngClass]="getTaskStatusClass(task.status)">
                                    {{ getTaskStatusText(task.status) }}
                                  </span>
                                </td>
                                <td [class.text-danger]="isDeadlinePassed(task.deadline, task.status)">
                                  {{ formatDeadline(task.deadline) }}
                                  @if (isDeadlinePassed(task.deadline, task.status)) {
                                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                  }
                                </td>
                                <td><span class="badge bg-info">{{ task.priority }}</span></td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>
